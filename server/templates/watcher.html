<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>WebRTC Watcher</title>

    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />
    <link rel="stylesheet" href="style.css" />
  </head>

  <body class="bg-dark-subtle" data-bs-theme="dark">
    <div class="position-relative">
      <video
        id="viewer"
        autoplay
        muted
        class="img-fluid rounded vh-100 vw-100 pt-1"
      ></video>
      <div class="position-absolute top-0 end-0 p-3">
        <button
          type="button"
          class="btn btn-dark"
          data-bs-toggle="modal"
          data-bs-target="#cameras"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="16"
            height="16"
            fill="currentColor"
            class="bi bi-camera-reels-fill"
            viewBox="0 0 16 16"
          >
            <path d="M6 3a3 3 0 1 1-6 0 3 3 0 0 1 6 0" />
            <path d="M9 6a3 3 0 1 1 0-6 3 3 0 0 1 0 6" />
            <path
              d="M9 6h.5a2 2 0 0 1 1.983 1.738l3.11-1.382A1 1 0 0 1 16 7.269v7.462a1 1 0 0 1-1.406.913l-3.111-1.382A2 2 0 0 1 9.5 16H2a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2z"
            />
          </svg>
        </button>
        <button id="btn-screen" type="button" class="btn btn-dark">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="16"
            height="16"
            fill="currentColor"
            class="bi bi-arrows-fullscreen"
            viewBox="0 0 16 16"
          >
            <path
              fill-rule="evenodd"
              d="M5.828 10.172a.5.5 0 0 0-.707 0l-4.096 4.096V11.5a.5.5 0 0 0-1 0v3.975a.5.5 0 0 0 .5.5H4.5a.5.5 0 0 0 0-1H1.732l4.096-4.096a.5.5 0 0 0 0-.707m4.344 0a.5.5 0 0 1 .707 0l4.096 4.096V11.5a.5.5 0 1 1 1 0v3.975a.5.5 0 0 1-.5.5H11.5a.5.5 0 0 1 0-1h2.768l-4.096-4.096a.5.5 0 0 1 0-.707m0-4.344a.5.5 0 0 0 .707 0l4.096-4.096V4.5a.5.5 0 1 0 1 0V.525a.5.5 0 0 0-.5-.5H11.5a.5.5 0 0 0 0 1h2.768l-4.096 4.096a.5.5 0 0 0 0 .707m-4.344 0a.5.5 0 0 1-.707 0L1.025 1.732V4.5a.5.5 0 0 1-1 0V.525a.5.5 0 0 1 .5-.5H4.5a.5.5 0 0 1 0 1H1.732l4.096 4.096a.5.5 0 0 1 0 .707"
            />
          </svg>
        </button>
      </div>
      <div class="position-absolute bottom-0 end-0 p-3">
        <div class="row">
          <div class="col"></div>
          <div class="col">
            <button id="btn-screen" type="button" class="btn btn-dark">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="16"
                height="16"
                fill="currentColor"
                class="bi bi-caret-up-fill"
                viewBox="0 0 16 16"
              >
                <path
                  d="m7.247 4.86-4.796 5.481c-.566.647-.106 1.659.753 1.659h9.592a1 1 0 0 0 .753-1.659l-4.796-5.48a1 1 0 0 0-1.506 0z"
                />
              </svg>
            </button>
          </div>
          <div class="col"></div>
        </div>
        <div class="row py-2">
          <div class="col">
            <button id="btn-screen" type="button" class="btn btn-dark">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="16"
                height="16"
                fill="currentColor"
                class="bi bi-caret-left-fill"
                viewBox="0 0 16 16"
              >
                <path
                  d="m3.86 8.753 5.482 4.796c.646.566 1.658.106 1.658-.753V3.204a1 1 0 0 0-1.659-.753l-5.48 4.796a1 1 0 0 0 0 1.506z"
                />
              </svg>
            </button>
          </div>
          <div class="col">
            <button id="btn-screen" type="button" class="btn btn-danger">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="16"
                height="16"
                fill="currentColor"
                class="bi bi-stop-circle-fill"
                viewBox="0 0 16 16"
              >
                <path
                  d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0M6.5 5A1.5 1.5 0 0 0 5 6.5v3A1.5 1.5 0 0 0 6.5 11h3A1.5 1.5 0 0 0 11 9.5v-3A1.5 1.5 0 0 0 9.5 5z"
                />
              </svg>
            </button>
          </div>
          <div class="col">
            <button id="btn-screen" type="button" class="btn btn-dark">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="16"
                height="16"
                fill="currentColor"
                class="bi bi-caret-right-fill"
                viewBox="0 0 16 16"
              >
                <path
                  d="m12.14 8.753-5.482 4.796c-.646.566-1.658.106-1.658-.753V3.204a1 1 0 0 1 1.659-.753l5.48 4.796a1 1 0 0 1 0 1.506z"
                />
              </svg>
            </button>
          </div>
        </div>
        <div class="row">
          <div class="col"></div>
          <div class="col">
            <button id="btn-screen" type="button" class="btn btn-dark">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="16"
                height="16"
                fill="currentColor"
                class="bi bi-caret-down-fill"
                viewBox="0 0 16 16"
              >
                <path
                  d="M7.247 11.14 2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z"
                />
              </svg>
            </button>
          </div>
          <div class="col"></div>
        </div>
      </div>
    </div>

    <!-- Modal -->
    <div
      class="modal fade"
      id="cameras"
      tabindex="-1"
      aria-labelledby="camerasLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-dialog-centered modal-lg modal-xl">
        <div class="modal-content">
          <div class="modal-header">
            <h1 class="modal-title fs-5" id="camerasLabel">Streams</h1>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <div id="container-video" class="row"></div>
          </div>
        </div>
      </div>
    </div>
  </body>

  <script
    src="https://cdn.socket.io/4.7.5/socket.io.min.js"
    integrity="sha384-2huaZvOR9iDzHqslqwpR87isEmrfxqyWOF7hr7BY6KG0+hVKLoEXMPUJw3ynWuhO"
    crossorigin="anonymous"
  ></script>
  <script
    src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
    crossorigin="anonymous"
  ></script>
  <script src="index.js"></script>
  <script src="CardReload.js"></script>

  <script>
    const container = document.getElementById("container-video");
    const btn = document.getElementById("btn-screen");
    const viewer = document.getElementById("viewer");
    const room = new Room("Video-streaming");
    socket.emit("watcher");
    var elem = document.documentElement;

    /* View in fullscreen */
    function openFullscreen() {
      if (elem.requestFullscreen) {
        elem.requestFullscreen();
      } else if (elem.webkitRequestFullscreen) {
        /* Safari */
        elem.webkitRequestFullscreen();
      } else if (elem.msRequestFullscreen) {
        /* IE11 */
        elem.msRequestFullscreen();
      }
      btn.onclick = closeFullscreen;
    }
    btn.onclick = openFullscreen;

    /* Close fullscreen */
    function closeFullscreen() {
      if (document.exitFullscreen) {
        document.exitFullscreen();
      } else if (document.webkitExitFullscreen) {
        /* Safari */
        document.webkitExitFullscreen();
      } else if (document.msExitFullscreen) {
        /* IE11 */
        document.msExitFullscreen();
      }
      btn.onclick = openFullscreen;
    }

    room.onUpdate(() => {
      container.innerHTML = "";

      room.connections.forEach((connection, i) => {
        if (!viewer.srcObject && i === 0) {
          viewer.srcObject = connection.stream;
        }

        let state = connection.peerConnection.connectionState;
        let content = document.createElement("div");
        content.className = "col-12 col-md-6 col-lg-4";
        content.appendChild(
          CardConnectionVideo({
            user: connection.to,
            status: state,
            src: connection.stream,
            onReload: () => {
              console.log("Reload", connection.to);
              socket.emit("watcher");
            },
            onDelete: () => {
              console.log("Delete");
              room.connections.splice(i, 1);
              room.handlerUpdate();
            },
            onView: () => (viewer.srcObject = connection.stream),
          })
        );

        container.appendChild(content);
      });
    });
    socket.on("broadcaster", () => {
      console.log("broadcaster");
      socket.emit("watcher");
    });

    socket.on("connect", () => {
      room.setId(socket.id);
    });
    socket.on("offer", async ({ to, from, offer }) => {
      room.offer(to, from, offer);
    });
    socket.on("candidate", async ({ to, from, candidate }) => {
      room.onCandidate(to, from, candidate);
    });

    // // const socket = io.connect("https://j9drrtjb-5000.euw.devtunnels.ms/");

    // // const socket = io.connect("http://127.0.0.1:5000/");
    // // const socket = io("http://127.0.0.1:5000/");
    // const socket = io("https://" + window.location.host, { secure: false });
    // let id = null;
    // let peerConnection;
    // const config = {
    //   iceServers: [
    //     { urls: "stun:stun.l.google.com:19302" },
    //     // {
    //     //   urls: "stun:stun.relay.metered.ca:80",
    //     // },
    //     // {
    //     //   urls: "turn:global.relay.metered.ca:80",
    //     //   username: "8dd074099f122d9108cf7547",
    //     //   credential: "8WuSKQ7RqzQ+jknR",
    //     // },
    //     // {
    //     //   urls: "turn:global.relay.metered.ca:80?transport=tcp",
    //     //   username: "8dd074099f122d9108cf7547",
    //     //   credential: "8WuSKQ7RqzQ+jknR",
    //     // },
    //     // {
    //     //   urls: "turn:global.relay.metered.ca:443",
    //     //   username: "8dd074099f122d9108cf7547",
    //     //   credential: "8WuSKQ7RqzQ+jknR",
    //     // },
    //     // {
    //     //   urls: "turns:global.relay.metered.ca:443?transport=tcp",
    //     //   username: "8dd074099f122d9108cf7547",
    //     //   credential: "8WuSKQ7RqzQ+jknR",
    //     // },
    //   ],
    // };
    // peerConnection = new RTCPeerConnection(config);
    // peerConnection.addEventListener("connectionstatechange", (event) => {
    //   console.log(`connection: ${peerConnection.connectionState}`);
    //   // alert(`connection: ${peerConnection.connectionState}`);
    // });
    // socket.on("offer", async (res) => {
    //   console.log("Offer broadcast");
    //   // console.log(res);

    //   peerConnection.onicecandidate = (event) => {
    //     if (event.candidate) {
    //       socket.emit("candidate", event.candidate);
    //     }
    //   };

    //   peerConnection.ontrack = (event) => {
    //     console.log("track");
    //     remoteVideo.srcObject = event.streams[0];
    //   };
    //   if (res.to !== socket.id) {
    //     return;
    //   }
    //   console.log("Set remote description");
    //   await peerConnection.setRemoteDescription(
    //     new RTCSessionDescription(res.offer)
    //   );
    //   const answer = await peerConnection.createAnswer();
    //   await peerConnection.setLocalDescription(answer);
    //   console.log("Sending answer");

    //   socket.emit("answer", answer);
    // });

    // socket.on("candidate", async (candidate) => {
    //   console.log("candidate");
    //   if (!peerConnection.remoteDescription) {
    //     return;
    //   }
    //   await peerConnection.addIceCandidate(new RTCIceCandidate(candidate));
    // });

    // socket.on("broadcaster", () => {
    //   console.log("Broadcaster detected");
    //   console.log("Sending watch req");
    //   socket.emit("watcher");
    // });

    // socket.on("connect", function (data) {
    //   console.log("Received ID:", socket.id);
    //   socket.emit("watcher");
    // });
    // socket.on("frame", (frame) => {
    //   let previous_date = new Date();
    //   const blob = new Blob([frame.buffer], { type: "image/jpeg" });
    //   const url = URL.createObjectURL(blob);
    //   const receivedImage = document.getElementById("receivedImage");
    //   receivedImage.src = url;
    //   let current_date = new Date();
    //   let second_diff =
    //     (current_date.getTime() - previous_date.getTime()) / 1000;
    //   console.log(frame);
    //   console.log("time: ", second_diff);
    // });

    // window.onunload = window.onbeforeunload = () => {
    //   socket.disconnect();
    // };
  </script>
</html>
