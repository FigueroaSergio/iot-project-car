<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>WebRTC Watcher</title>
  </head>
  <body>
    <h1>WebRTC Watcher</h1>
    <video id="remoteVideo" width="640" height="480" autoplay muted></video>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script>
      const remoteVideo = document.getElementById("remoteVideo");

      const socket = io.connect("https://j9drrtjb-5000.euw.devtunnels.ms/");
      let id = null;
      let peerConnection;
      const config = {
        iceServers: [
          { urls: "stun:stun.l.google.com:19302" },
          // {
          //   urls: "stun:stun.relay.metered.ca:80",
          // },
          // {
          //   urls: "turn:global.relay.metered.ca:80",
          //   username: "8dd074099f122d9108cf7547",
          //   credential: "8WuSKQ7RqzQ+jknR",
          // },
          // {
          //   urls: "turn:global.relay.metered.ca:80?transport=tcp",
          //   username: "8dd074099f122d9108cf7547",
          //   credential: "8WuSKQ7RqzQ+jknR",
          // },
          // {
          //   urls: "turn:global.relay.metered.ca:443",
          //   username: "8dd074099f122d9108cf7547",
          //   credential: "8WuSKQ7RqzQ+jknR",
          // },
          // {
          //   urls: "turns:global.relay.metered.ca:443?transport=tcp",
          //   username: "8dd074099f122d9108cf7547",
          //   credential: "8WuSKQ7RqzQ+jknR",
          // },
        ],
      };
      peerConnection = new RTCPeerConnection(config);
      peerConnection.addEventListener("connectionstatechange", (event) => {
        console.log(`connection: ${peerConnection.connectionState}`);
        alert(`connection: ${peerConnection.connectionState}`);
      });
      socket.on("offer", async (res) => {
        console.log("Offer broadcast");

        peerConnection.onicecandidate = (event) => {
          if (event.candidate) {
            socket.emit("candidate", event.candidate);
          }
        };

        peerConnection.ontrack = (event) => {
          console.log("track");
          remoteVideo.srcObject = event.streams[0];
        };
        if (res.to !== id) {
          return;
        }
        console.log("Sending answer");
        await peerConnection.setRemoteDescription(
          new RTCSessionDescription(res.offer)
        );
        const answer = await peerConnection.createAnswer();
        await peerConnection.setLocalDescription(answer);

        socket.emit("answer", answer);
      });

      socket.on("candidate", async (candidate) => {
        console.log("candidate");
        if (!peerConnection.remoteDescription) {
          return;
        }
        await peerConnection.addIceCandidate(new RTCIceCandidate(candidate));
      });

      socket.on("broadcaster", () => {
        console.log("Broadcaster detected");
        console.log("Sending watch req");
        if (id) {
          socket.emit("watcher", id);
        }
      });

      socket.on("assign_id", function (data) {
        console.log("Received ID:", data.id);
        id = data.id;
        socket.emit("watcher", id);
      });

      window.onunload = window.onbeforeunload = () => {
        socket.close();
      };
    </script>
  </body>
</html>
